<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Staff Contract Signing - Wing Kong Properties</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .signature-canvas {
            border: 2px dashed #dee2e6;
            border-radius: 5px;
            cursor: crosshair;
            background: white;
        }
        .contract-status-badge {
            font-size: 0.9em;
        }
    </style>
</head>
<body>
    <div class="container mt-4">
        <div class="row justify-content-center">
            <div class="col-md-10">
                <!-- Header -->
                <div class="card mb-4 border-0 shadow-sm">
                    <div class="card-header bg-info text-white">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h3 class="mb-1"><i class="fas fa-building"></i> Staff Contract Signing</h3>
                                <p class="mb-0">Authorized Representative Signature</p>
                            </div>
                            <div class="text-end">
                                <small>Wing Kong Property Management</small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Contract Details -->
                <div class="card mb-4 shadow-sm">
                    <div class="card-header bg-light">
                        <h5 class="mb-0"><i class="fas fa-info-circle"></i> Contract Information</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <table class="table table-sm table-borderless">
                                    <tr>
                                        <td class="text-muted"><strong>Contract Number:</strong></td>
                                        <td><strong>{{ contract.contract_number }}</strong></td>
                                    </tr>
                                    <tr>
                                        <td class="text-muted"><strong>Tenant:</strong></td>
                                        <td>{{ contract.booking.tenant.full_name }}</td>
                                    </tr>
                                    <tr>
                                        <td class="text-muted"><strong>Room:</strong></td>
                                        <td>{{ contract.booking.room.room_code }}</td>
                                    </tr>
                                    <tr>
                                        <td class="text-muted"><strong>Term:</strong></td>
                                        <td>{{ contract.start_date }} to {{ contract.end_date }}</td>
                                    </tr>
                                </table>
                            </div>
                            <div class="col-md-6">
                                <table class="table table-sm table-borderless">
                                    <tr>
                                        <td class="text-muted"><strong>Staff Member:</strong></td>
                                        <td><strong>{{ staff_member.get_full_name|default:staff_member.username }}</strong></td>
                                    </tr>
                                    <tr>
                                        <td class="text-muted"><strong>Tenant Signed:</strong></td>
                                        <td>
                                            {% if contract.digital_signature_tenant %}
                                            <span class="badge bg-success contract-status-badge">
                                                <i class="fas fa-check-circle"></i> Yes - {{ contract.tenant_signed_date|date:"M d, Y" }}
                                            </span>
                                            {% else %}
                                            <span class="badge bg-warning contract-status-badge">
                                                <i class="fas fa-clock"></i> Pending
                                            </span>
                                            {% endif %}
                                        </td>
                                    </tr>
                                    <tr>
                                        <td class="text-muted"><strong>Contract Status:</strong></td>
                                        <td>
                                            <span class="badge bg-{% if contract.status == 'signed' %}success{% else %}secondary{% endif %} contract-status-badge">
                                                {{ contract.get_status_display }}
                                            </span>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td class="text-muted"><strong>Monthly Rent:</strong></td>
                                        <td class="text-success"><strong>HK$ {{ contract.monthly_rent }}</strong></td>
                                    </tr>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Staff Signature Section -->
                <div class="card shadow-sm">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0"><i class="fas fa-signature"></i> Authorized Representative Signature</h5>
                    </div>
                    <div class="card-body">
                        {% if not contract.digital_signature_tenant %}
                        <div class="alert alert-warning">
                            <div class="d-flex">
                                <i class="fas fa-exclamation-triangle fa-2x me-3 text-warning"></i>
                                <div>
                                    <h5>Awaiting Tenant Signature</h5>
                                    <p class="mb-0">The tenant has not signed the contract yet. Please wait for the tenant's signature before proceeding with staff authorization.</p>
                                </div>
                            </div>
                        </div>
                        {% else %}
                        <form method="post">
                            {% csrf_token %}

                            <div class="alert alert-info">
                                <div class="d-flex">
                                    <i class="fas fa-info-circle fa-2x me-3 text-info"></i>
                                    <div>
                                        <h5>Authorized Representative</h5>
                                        <p class="mb-0">
                                            As an authorized representative of Wing Kong Property Management,
                                            please provide your digital signature to execute this contract on behalf of the company.
                                        </p>
                                    </div>
                                </div>
                            </div>

                            <div class="text-center mb-4">
                                <canvas id="staff-signature-pad" width="600" height="200" class="signature-canvas"></canvas>
                                <div class="mt-2">
                                    <small class="text-muted">Draw your authorized signature in the box above</small>
                                </div>
                            </div>

                            <div class="text-center">
                                <button type="button" id="clear-staff-signature" class="btn btn-outline-secondary me-2">
                                    <i class="fas fa-eraser"></i> Clear Signature
                                </button>
                                <button type="submit" id="submit-staff-signature" class="btn btn-success btn-lg" disabled>
                                    <i class="fas fa-check-circle"></i> Execute Contract
                                </button>
                            </div>

                            <input type="hidden" name="signature" id="staff-signature-data">

                            <div class="mt-4 alert alert-warning">
                                <small>
                                    <i class="fas fa-exclamation-triangle"></i>
                                    <strong>Legal Notice:</strong> This signature authorizes and executes the tenancy agreement on behalf of Wing Kong Property Management.
                                    Ensure all contract terms are correct before signing.
                                </small>
                            </div>
                        </form>
                        {% endif %}

                        <!-- Back to CRM Button -->
                        <div class="mt-4 text-center">
                            <a href="/crm/contracts/" class="btn btn-outline-primary">
                                <i class="fas fa-arrow-left"></i> Back to Contracts CRM
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap & JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const canvas = document.getElementById('staff-signature-pad');
            const clearBtn = document.getElementById('clear-staff-signature');
            const submitBtn = document.getElementById('submit-staff-signature');
            const signatureInput = document.getElementById('staff-signature-data');

            if (canvas) {
                const ctx = canvas.getContext('2d');
                let isDrawing = false;
                let lastX = 0;
                let lastY = 0;

                // Set canvas background
                ctx.fillStyle = 'white';
                ctx.fillRect(0, 0, canvas.width, canvas.height);

                // Set drawing style
                ctx.strokeStyle = '#000';
                ctx.lineWidth = 2;
                ctx.lineJoin = 'round';
                ctx.lineCap = 'round';

                // Mouse events
                canvas.addEventListener('mousedown', startDrawing);
                canvas.addEventListener('mousemove', draw);
                canvas.addEventListener('mouseup', stopDrawing);
                canvas.addEventListener('mouseout', stopDrawing);

                function startDrawing(e) {
                    isDrawing = true;
                    [lastX, lastY] = getCoordinates(e);
                }

                function draw(e) {
                    if (!isDrawing) return;
                    e.preventDefault();

                    const [x, y] = getCoordinates(e);

                    ctx.beginPath();
                    ctx.moveTo(lastX, lastY);
                    ctx.lineTo(x, y);
                    ctx.stroke();

                    [lastX, lastY] = [x, y];

                    // Enable submit button and store signature data
                    submitBtn.disabled = false;
                    signatureInput.value = canvas.toDataURL();
                }

                function stopDrawing() {
                    isDrawing = false;
                    signatureInput.value = canvas.toDataURL();
                }

                function getCoordinates(e) {
                    const rect = canvas.getBoundingClientRect();
                    const scaleX = canvas.width / rect.width;
                    const scaleY = canvas.height / rect.height;

                    return [
                        (e.clientX - rect.left) * scaleX,
                        (e.clientY - rect.top) * scaleY
                    ];
                }

                // Clear signature
                clearBtn.addEventListener('click', function() {
                    ctx.fillStyle = 'white';
                    ctx.fillRect(0, 0, canvas.width, canvas.height);
                    submitBtn.disabled = true;
                    signatureInput.value = '';
                });
            }
        });
    </script>
</body>
</html>