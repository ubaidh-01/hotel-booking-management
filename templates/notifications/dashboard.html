{% extends 'reports/base.html' %}

{% block title %}{{ title }}{% endblock %}

{% block content %}
<!-- Page Header -->
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h2 class="mb-1">{{ title }}</h2>
        <p class="text-muted mb-0">Date: {{ today }} | Monitor your automated notification system</p>
    </div>
    <div>
        <a href="{% url 'reports:dashboard' %}" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left me-2"></i> Back to Dashboard
        </a>
    </div>
</div>

<!-- Statistics Cards -->
<div class="row mb-4">
    <div class="col-xl-3 col-md-6 mb-4">
        <div class="stats-card info">
            <div class="stats-icon">
                <i class="fas fa-paper-plane"></i>
            </div>
            <div class="stats-number">{{ stats.total_sent }}</div>
            <div class="stats-label">Total Notifications Sent</div>
        </div>
    </div>

    <div class="col-xl-3 col-md-6 mb-4">
        <div class="stats-card {% if stats.total_failed > 0 %}danger{% else %}success{% endif %}">
            <div class="stats-icon">
                <i class="fas fa-exclamation-triangle"></i>
            </div>
            <div class="stats-number">{{ stats.total_failed }}</div>
            <div class="stats-label">Failed Notifications</div>
        </div>
    </div>

    <div class="col-xl-3 col-md-6 mb-4">
        <div class="stats-card primary">
            <div class="stats-icon">
                <i class="fas fa-calendar-day"></i>
            </div>
            <div class="stats-number">{{ stats.today_sent }}</div>
            <div class="stats-label">Sent Today</div>
        </div>
    </div>

    <div class="col-xl-3 col-md-6 mb-4">
        <div class="stats-card warning">
            <div class="stats-icon">
                <i class="fas fa-money-bill-wave"></i>
            </div>
            <div class="stats-number">{{ stats.rent_reminders }}</div>
            <div class="stats-label">Rent Reminders</div>
        </div>
    </div>
</div>

<div class="row">
    <!-- Quick Actions -->
    <div class="col-lg-4 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-rocket me-2"></i> Quick Actions</h5>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <a href="{% url 'notifications:test_notification' %}" class="btn btn-primary" onclick="return confirm('Send test email?')">
                        <i class="fas fa-envelope me-2"></i> Send Test Email
                    </a>
                    <a href="/admin/notifications/notificationlog/" class="btn btn-outline-secondary" target="_blank">
                        <i class="fas fa-list me-2"></i> View All Logs
                    </a>
                    <a href="/admin/django_celery_beat/periodictask/" class="btn btn-outline-info" target="_blank">
                        <i class="fas fa-clock me-2"></i> Manage Schedules
                    </a>
                    <a href="/admin/" class="btn btn-outline-warning" target="_blank">
                        <i class="fas fa-cog me-2"></i> Admin Panel
                    </a>
                </div>
            </div>
        </div>

        <!-- System Status -->
        <div class="card mt-4">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-heartbeat me-2"></i> System Status</h5>
            </div>
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <span>Email Service</span>
                    <span class="badge bg-success">Operational</span>
                </div>
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <span>Scheduler</span>
                    <span class="badge bg-success">Running</span>
                </div>
                <div class="d-flex justify-content-between align-items-center">
                    <span>Database</span>
                    <span class="badge bg-success">Connected</span>
                </div>

                <div class="mt-3">
                    <small class="text-muted">Last checked: {{ today }}</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="col-lg-8 mb-4">
        <!-- Automated Tasks Schedule -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-clock me-2"></i> Automated Tasks Schedule</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Task</th>
                                <th>Schedule</th>
                                <th>Description</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><strong>Rent Reminders</strong></td>
                                <td>Daily at 9:00 AM</td>
                                <td>3-day reminders + overdue notices</td>
                                <td><span class="badge bg-success">ACTIVE</span></td>
                            </tr>
                            <tr>
                                <td><strong>Late Fee Processing</strong></td>
                                <td>Daily at 9:00 AM</td>
                                <td>HK$100/day fees + court notices</td>
                                <td><span class="badge bg-success">ACTIVE</span></td>
                            </tr>
                            <tr>
                                <td><strong>Contract Reminders</strong></td>
                                <td>Daily at 9:00 AM</td>
                                <td>3-week renewal reminders</td>
                                <td><span class="badge bg-success">ACTIVE</span></td>
                            </tr>
                            <tr>
                                <td><strong>Birthday Wishes</strong></td>
                                <td>Daily at 9:00 AM</td>
                                <td>Auto birthday emails</td>
                                <td><span class="badge bg-success">ACTIVE</span></td>
                            </tr>
                            <tr>
                                <td><strong>Room Status Sync</strong></td>
                                <td>Daily at 6:00 AM</td>
                                <td>Sync room status with bookings</td>
                                <td><span class="badge bg-success">ACTIVE</span></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Recent Notifications -->
        <div class="card mt-4">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-envelope me-2"></i> Recent Notifications (Last 7 Days)</h5>
            </div>
            <div class="card-body">
                {% if recent_notifications %}
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Tenant</th>
                                <th>Type</th>
                                <th>Subject</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for notification in recent_notifications %}
                            <tr>
                                <td>{{ notification.sent_at|date:"M d, H:i"|default:"Pending" }}</td>
                                <td>
                                    {% if notification.tenant %}
                                        {{ notification.tenant.full_name }}
                                    {% else %}
                                        System
                                    {% endif %}
                                </td>
                                <td>{{ notification.get_notification_type_display }}</td>
                                <td>{{ notification.subject }}</td>
                                <td>
                                    {% if notification.status == 'sent' %}
                                        <span class="badge bg-success">✅ Sent</span>
                                    {% elif notification.status == 'failed' %}
                                        <span class="badge bg-danger">❌ Failed</span>
                                    {% else %}
                                        <span class="badge bg-warning">⏳ Pending</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center py-4">
                    <i class="fas fa-envelope-open-text fa-3x text-muted mb-3"></i>
                    <p class="text-muted">No notifications sent in the last 7 days.</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Notification Types Info -->
<div class="card">
    <div class="card-header">
        <h5 class="mb-0"><i class="fas fa-info-circle me-2"></i> Notification Types & Triggers</h5>
    </div>
    <div class="card-body">
        <div class="row g-4">
            <div class="col-md-4">
                <div class="card h-100 border-0 shadow-sm">
                    <div class="card-body">
                        <h5 class="card-title"><i class="fas fa-money-bill-wave text-warning me-2"></i> Rent Reminders</h5>
                        <ul class="list-group list-group-flush">
                            <li class="list-group-item px-0"><strong>3 days before due:</strong> Friendly reminder</li>
                            <li class="list-group-item px-0"><strong>Due date:</strong> Payment due notice</li>
                            <li class="list-group-item px-0"><strong>1 day overdue:</strong> Late fee warning (HK$100/day)</li>
                            <li class="list-group-item px-0"><strong>7 days overdue:</strong> Late fee invoice</li>
                            <li class="list-group-item px-0"><strong>14 days overdue:</strong> Court notice</li>
                        </ul>
                    </div>
                </div>
            </div>

            <div class="col-md-4">
                <div class="card h-100 border-0 shadow-sm">
                    <div class="card-body">
                        <h5 class="card-title"><i class="fas fa-file-contract text-info me-2"></i> Contract Management</h5>
                        <ul class="list-group list-group-flush">
                            <li class="list-group-item px-0"><strong>21 days before end:</strong> Renewal reminder</li>
                            <li class="list-group-item px-0"><strong>Extension options:</strong> Yes/No response</li>
                            <li class="list-group-item px-0"><strong>Auto-followup:</strong> For non-responses</li>
                        </ul>
                    </div>
                </div>
            </div>

            <div class="col-md-4">
                <div class="card h-100 border-0 shadow-sm">
                    <div class="card-body">
                        <h5 class="card-title"><i class="fas fa-birthday-cake text-danger me-2"></i> Tenant Relations</h5>
                        <ul class="list-group list-group-flush">
                            <li class="list-group-item px-0"><strong>Birthdays:</strong> Auto wishes for current tenants</li>
                            <li class="list-group-item px-0"><strong>HK$100 credit:</strong> Birthday gift on next rent</li>
                            <li class="list-group-item px-0"><strong>Excludes:</strong> Moved-out tenants</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}